<!DOCTYPE html>
<html>

<head>
  <title>Autodesk Forge - BIM 360 Assets</title>
  <meta charset="utf-8" />
  <link rel="shortcut icon" href="https://github.com/Autodesk-Forge/learn.forge.viewhubmodels/raw/master/img/favicon.ico">
  <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css" />
  <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
  <!-- <link rel="stylesheet" href="https://d1i0g0djlrabur.cloudfront.net/assets-5/dist/main.bundle.css" /> -->
  <link rel="stylesheet" href="../dist/timeslider.css" />
  <link rel="stylesheet" href="../dist/customtooltip.css" />
  <link rel="stylesheet" href="../dist/heatmapoptions.css" />
  
  <!-- <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script> -->
  <script src="../dist/vendor.js"></script>
  <script src="../dist/timeslider.js"></script>
  <script src="../dist/customtooltip.js"></script>
  <script src="./data.js"></script>

  <script src="../dist/heatmapoptions.js"></script>

  <style>
    html,
    body {
        min-height: 100%;
        height: 100%;
        margin: 0 0;
        overflow: hidden;
    }

    #timeline_header {
        width: 75%;
    }
  </style>
  
</head>

<body>
    <div id="timeline" style="width: 75%; height: 120px;"></div>
    <div id="heatmapOpts"></div>

    <div id="tooltip" style="position: absolute; width: 10px; height: 10px; top:350px; left: 250px; border: 1px solid black;"></div>

    <script>
        //!-- ChronosTimeSlider
        var currentTime = new Date();
        currentTime.setUTCHours(0, 0, 0, 0);
        var endTime = new Date(currentTime.getTime() + 1 * 24 * 60 * 60 * 1000);
        endTime.setUTCHours(0, 0, 0, 0);
        var startTime = new Date(currentTime.getTime() - 14 * 24 * 60 * 60 * 1000);
        startTime.setUTCHours(0, 0, 0, 0);

        var timeOptions = new Autodesk.DataVisualization.UI.TimeOptions(startTime, endTime, currentTime);
        var timeSliderOptions = {
            dataStart: startTime,
            dataEnd: endTime,
            timeOptions,
            handleTimeRangeUpdated: (startTime, endTime, currentTime) => console.log(startTime, endTime, currentTime),
            handleCurrentTimeUpdated: (currentTime) => console.log(currentTime)
        };
        var timeSliderCtrl = new Autodesk.DataVisualization.UI.ChronosTimeSliderControl(document.getElementById('timeline'), timeSliderOptions);

        timeSliderCtrl.addEventListener(
            Autodesk.DataVisualization.UI.TIME_SLIDER_CONTROL_INITIALIZED_EVENT,
            (event) => console.log(event)
        );

        timeSliderCtrl.addEventListener(
            Autodesk.DataVisualization.UI.TIME_SLIDER_CONTROL_TIME_RANGE_UPDATED_EVENT,
            (event) => console.log(event)
        );

        timeSliderCtrl.addEventListener(
            Autodesk.DataVisualization.UI.TIME_SLIDER_CONTROL_CURRENT_TIME_UPDATED_EVENT,
            (event) => console.log(event)
        );

        timeSliderCtrl.initialize();

        //!-- HeatmapOptions
        /**
         * Gets the selected property's range min, max and dataUnit value.
         *
         * @param {string} propertyId String identifier of a device property.
         * @returns {Object} The rangeMin, rangeMax and dataUnit for the selected propertyId
         */
        function getPropertyRanges(propertyId, propertyMap) {
            if (propertyId !== "None") {
                let dataUnit = "";
                let rangeMin = Infinity;
                let rangeMax = -Infinity;

                //Get the property data from the device model
                let deviceProperty = propertyMap.get(propertyId);

                if (deviceProperty) {
                    dataUnit = deviceProperty.dataUnit;
                    dataUnit = dataUnit.toLowerCase() === "celsius" ? "°C" : dataUnit;
                    dataUnit = dataUnit.toLowerCase() === "fahrenheit" ? "°F" : dataUnit;
                    rangeMin = Math.min(rangeMin, deviceProperty.rangeMin); // will be NaN if deviceProperty.rangeMin == undefined or NaN
                    rangeMax = Math.max(rangeMax, deviceProperty.rangeMax); // will be NaN if deviceProperty.rangeMax == undefined or NaN
                }

                // Check if the property min and max range is available in the device model, else notify user
                if (isNaN(rangeMin) || isNaN(rangeMax)) {
                    console.warn(
                        `RangeMin and RangeMax for ${propertyId} not specified. Please update these values in the device model`
                    );
                    rangeMin = 0;
                    rangeMax = 100;
                    dataUnit = "%";
                }
                return { rangeMin, rangeMax, dataUnit };
            }
        }

        var heatmapOptsContainer = document.getElementById('heatmapOpts');
        var heatmapOptions = {
            propIdGradientMap,
            deviceModelProperties,
            getPropertyRanges: (propertyId) => getPropertyRanges(propertyId, deviceModelProperties)
        };
        var heatmapOptsCtrl = new Autodesk.DataVisualization.UI.HeatmapOptionsControlControl(heatmapOptsContainer, heatmapOptions);

        heatmapOptsCtrl.addEventListener(
            Autodesk.DataVisualization.UI.HEATMAP_OPTIONS_CONTROL_INITIALIZED_EVENT,
            (event) => console.log(event)
        );

        heatmapOptsCtrl.addEventListener(
            Autodesk.DataVisualization.UI.HEATMAP_OPTIONS_CONTROL_STATE_CHANGED_EVENT,
            (event) => console.log(event)
        );

        heatmapOptsCtrl.initialize();

         //!-- Custom Tooltip
        var tooltipContainer = document.getElementById('tooltip');
        var tooltip = new Autodesk.DataVisualization.UI.CustomTooltipControl(tooltipContainer);
        tooltip.initialize();

        tooltipContainer.addEventListener(
            'mouseleave',
            () => {
                tooltip.hide();
            });

         tooltipContainer.addEventListener(
            'mouseenter',
            () => {
                tooltip.show(tooltipData);
            });
    </script>
</body>

</html>